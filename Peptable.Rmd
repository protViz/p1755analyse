---
title: "Analysing MaxQuant Output with R"
author: "Witold Wolski"
date: "30 September 2015"
output: pdf_document
toc: yes
---

# Prepare mrm table

- nr of assigned spectra (MS2) / versus total spectra
- How many H/L target peptides are identified
- Ratio among H/L of the target peptides
- Intensity of heavy or light over the runs

```{r, echo=FALSE, results="hide", message=FALSE}
library(dplyr)
library(DBI)
library(knitr)
library(reshape2)
library(quantable)
library(scales)
library(p1755)
opts_chunk$set(echo=FALSE, results="hide")

```


```{r}
if(FALSE){
  path <- "c:/processing/external/EXTERNAL_0/paolo_20151029_MSQC1/combined/txt"
  dbname <- "paolo_20151029_MSQC1.sqlite3"
} else if(FALSE){
  path <- "c:/processing/external/EXTERNAL_1/jennifergarcia_20150923_firstBatchFromCRG/combined/txt"
  dbname <- "jennifergarcia_20150923_firstBatchFromCRG.sqlite3"
} else if(TRUE){
  path <- "c:/processing/external/EXTERNAL_2/evytimmerman_20150929/combined/txt"
  dbname <- "evytimmerman_20150929.sqlite3"
} else if(TRUE){
  path <- "c:/processing/external/EXTERNAL_3/ashevche_20151030_MSQC1/combined/txt"
  dbname <- "ashevche_20151030_MSQC1.sqlite3"
} else if(FALSE){
  path <- "c:/processing/external/EXTERNAL_4/mechtler_20150609_Qex4/combined/txt/"
  dbname <- "mechtler_20150609_Qex4"
}


sqliteLocation <- "../output/"
p1755::createSQLiteDB( path , sqliteLocation, dbname )
dbpath = file.path(sqliteLocation,dbname) 

```

# Analysed Dataset is `r dbname`

```{r,echo=FALSE, results="hide", message=FALSE}
mrm <- p1755::loadMSQC1Transitions()
protidS <- as.character(unique(mrm$uniprotID))
mrm <- tbl_df(mrm)
mrm %>% group_by(Peptide, `Protein Name`) %>% summarise(pepcount = n())
peptidesMRM <-mrm %>% select(Peptide, uniprotID, `Protein Name`) %>% distinct %>% filter(!grepl("\\[" ,Peptide ) ) %>% arrange(Peptide)
theoryRatios <-  p1755::loadTheoryHLRatios()

```

# Number of spectra, spectra peptide matches, and unique peptides

```{r}

annotations <- tbl_df(read.table("../output/filemappingFinal.txt",header=TRUE,sep="\t"))
annotations %>% colnames
annotations$filename
annotations <- annotations %>% select(filename,displayname,siteinstrument,monthdate,week)
annotations$filename <- gsub(".raw","", annotations$filename)
annotations %>% glimpse

```


```{r, fig.height=8, fig.width=8}
my_mqdb <- src_sqlite(dbpath)
summary_tbl <- tbl(my_mqdb, "summary")
summary_tbl %>% glimpse
summary_tbl <- summary_tbl %>% select(Raw.file ,MS, MS.MS, MS.MS.Submitted, MS.MS.Identified,Peptide.Sequences.Identified )

summary_tbl2 <- inner_join(summary_tbl, annotations, by=c("Raw.file" = "filename"),copy=TRUE)
summary_tbl <- summary_tbl2 %>% collect
summary_tbl %>% glimpse

dd <- t(summary_tbl[,2:6])
class(dd)<-"numeric"
colnames(dd)<-summary_tbl$displayname  
colnames(dd)<-summary_tbl$week
as.matrix(dd)

ddx <- t(as.matrix(dd))
ddl <- melt(t(as.matrix(dd)))
colnames(ddl)<-c("week","type","nr")
library(lattice)
xyplot( nr ~ week, group =  type ,data=ddl,type="b",layout=c(1,1),
        scales = list(y = list(log = 10, equispaced.log = FALSE),x = list(cex=1,at=min(ddl$week):max(ddl$week)))
        ,auto.key = TRUE)

```


<!-- # Peptide Evidence -->

```{r}
dbListTables( my_mqdb$con )

evidence_tbl <- tbl(my_mqdb, "evidence")

colnames(evidence_tbl)
evidence_tbl %>% select(Raw.file) %>% glimpse

evidence_tbl2 <- inner_join(evidence_tbl, annotations, by=c("Raw.file" = "filename"),copy=TRUE)
evidence_tbl <- evidence_tbl2 %>% collect
evidence_tbl <- evidence_tbl %>% rename(Experiment = displayname)
evidence_tbl %>% dim
evidence_tbl %>% glimpse

```

# Looking at measurement error

```{r}
evError <- evidence_tbl %>% select(Mass.Error..Da., Mass.Error..ppm., Experiment, week)
meanmasserror<-aggregate(Mass.Error..ppm.  ~ Experiment + week, data=evError,FUN=function(x){mean(abs(x))})

xyplot(Mass.Error..ppm. ~ week, data=meanmasserror ,type="b", ylab="mean(abs(Delta ppm))",
       scales=list(x = list(cex=1,at=min(ddl$week):max(ddl$week))),ylim=c(0,5),auto.key = TRUE)

```


```{r,fig.width=10, fig.height=10, eval=FALSE}
head(evError)
histogram( ~Mass.Error..ppm. | Experiment + week , data=evError, type="density")

```

# Looking at MSQC 1 peptide counts

```{r}

evidence <- evidence_tbl  %>% select(Experiment, Modifications, Sequence, Modified.sequence, contains("Intensity"), m.z,Charge, Calibrated.retention.time, week) 
evidence %>% select(Modifications) %>% distinct()

```


```{r}

peptidesMRM %>% glimpse()
resMRMQuant <- inner_join(peptidesMRM,evidence, by=c("Peptide"="Sequence"), copy=TRUE)
resMRMQuant %>% select(Peptide, Experiment)

plotPepFrequencies <- function(table, main="peptide count", plot=FALSE){
  rd <- table %>% group_by(Peptide,Experiment,week) %>% summarise(pepcount = n())  %>% arrange(Experiment)
  if(plot){
    colsGreen <- brewer_pal(palette = "Greens")(5)
    tmp <- acast(rd , Peptide ~ Experiment, value.var='pepcount' )
    ygreen <- gradient_n_pal(colsGreen)(seq(0, 1, length.out = (max(tmp, na.rm = TRUE))))
    imageWithLabels(t(tmp), marLeft = c(6,8,3,1), marRight = c(1,2,3,1),col=ygreen, main=main)
  }
  rd
}
rd <- plotPepFrequencies(resMRMQuant, main="all peptide count")
##xyplot(pepcount ~   week | Peptide ,  data = rd,type="b", layout=c(3,5),main="all peptide count")

```



```{r}
dim(resMRMQuant)
resMRMQuant %>% select(Modifications) %>% distinct()

tmpLys8Arg10 <- resMRMQuant %>% filter(grepl("Lys8", Modifications) |grepl("Arg10", Modifications) ) 
rd2 <- plotPepFrequencies(tmpLys8Arg10, main="labeled peptide count")

tmpNonLab <- resMRMQuant %>% filter(Modifications=="Unmodified" )
rd3 <- plotPepFrequencies(tmpNonLab , main="not labeled peptide count")
```

```{r, fig.width=8, fig.height=10}

head(rd2)
head(rd3)
xx <- cbind("all",rd)
head(xx)

rdd <- rbind(cbind(type = "all",rd),cbind(type = "H",rd2),cbind(type = "L",rd3))
dim(rdd)

xyplot(pepcount ~ week | Peptide ,  data = rdd, group=type, type="b", layout=c(2,7), pch=c(1,2,3), lty=c(1,2,3), main="all peptide count", par.settings = list(superpose.symbol = list(pch = 1:3)), auto.key = TRUE,scales=list(x = list(cex=0.8,at=min(rdd$week):max(rdd$week),rot=90)))

```

# Look at Intensities (by species)

```{r}

specProt <-evidence_tbl %>% select(Protein= Leading.razor.protein,Intensity, Experiment, week ) 
library(quantable)
head(specProt)

tmp<-strsplit(specProt$Protein, split="\\|")

dd <- sapply(tmp,length)
table(dd)

specProt$Protein[which(dd==1)]
specProt$Protein[which(dd==2)]
specProt$Protein[which(dd==3)]

detcategory <- function(x){ 
  unkown <- "other"
  if(length(x) == 1){
    return("CONT")
  }else if(length(x)==2){
    return("CONT")
  }else if(length(x) == 3){
    val <- x[[3]]
    if(grepl("ECOLI",val)){
      return("ECOLI")
    }else if(grepl("HUMAN$", val)) {
      return("HUMAN")
    }else if(grepl("HUMAN_MSQC1$",val)){
      return("MSQC1")
    }else{
      return(unkown)
    }
  }else{
    return(unkown)
  }
}

category <- sapply(tmp, detcategory )
table(category)
specProt <- data.frame(specProt, category)
```

```{r, fig.width=10, fig.height=10, eval=FALSE}
bwplot( Intensity ~ category |  Experiment + week ,  data=specProt,scales=list(x=list(rot=45),y=list(log=10)))
```

```{r, fig.width=10, fig.height=10}
res <-aggregate(Intensity ~ category + Experiment + week, data=specProt, FUN=sum)
head(res)
xyplot(Intensity ~ week, group=category, data= res,auto.key = TRUE, type="b",scales=list(x=list(rot=45),y=list(log=10)))

```


# Looking at intensities msqc1


```{r}
lys8AggArg10 <- tmpLys8Arg10 %>% group_by(Peptide, uniprotID, Charge, Experiment, week) %>% summarise(IntensityN = sum(Intensity, na.rm =TRUE))
lys8AggArg10 %>% glimpse

nonLAgg <- tmpNonLab %>% group_by(Peptide,uniprotID,Charge,Experiment,week) %>% summarise(IntensityN = sum(Intensity, na.rm =TRUE))
nonLAgg %>% glimpse

resLys8Arg10None <- inner_join(lys8AggArg10, nonLAgg,by=c("Peptide"="Peptide", "Experiment" = "Experiment",
                                                          "Charge" = "Charge", "uniprotID"  = "uniprotID", "week"="week"))

for( i in which(lapply(resLys8Arg10None, class) == "character")){
  resLys8Arg10None[[i]] <- as.factor(resLys8Arg10None[[i]])
}

```

```{r,fig.width=8, fig.height=10}

library(lattice)
xyplot(IntensityN.y  ~ week | Peptide ,group= Charge, data= resLys8Arg10None , scales=list(x=list(rot=90),y=list(log=10)),type="b",layout=c(2,6), auto.key=TRUE, main="light") 

```


```{r,fig.width=8, fig.height=10}
xyplot(IntensityN.x  ~ week | Peptide  , group= Charge, data= resLys8Arg10None , scales=list(x=list(rot=90), y=list(log=10)),type="b", auto.key=TRUE, main="heavy", layout=c(2,6) ) 
```

```{r}
theoryRatios <- read.table("theoryRatios.txt",sep=" ")
theoryRatios[,1] <- gsub("\\[|\\]","",theoryRatios[,1])
theoryRatios[,4] <- log2(theoryRatios[,3])
theoryRatios
colnames(theoryRatios) <- c("Pepsequence", "concentration", "foldchange" , "log2fc")
theoryRatios<-theoryRatios[order(theoryRatios$Pepsequence),]
```

# Fold change

```{r,fig.width=8, fig.height=10}
idx <- order(unique(resLys8Arg10None$Peptide))
peptide.idx <- unique(resLys8Arg10None$Peptide)[idx]
xyplot(log2(IntensityN.y/IntensityN.x)  ~ week | Peptide, 
       index.cond=list(idx),
       group = Charge, 
       data = resLys8Arg10None, 
       scales = list(x=list(rot=90)),
       type="b", 
       auto.key = TRUE, 
       main="H/L", 
       layout=c(2,6), 
       panel=function(...){
         panel.abline(h=theoryRatios[theoryRatios$Pepsequence == peptide.idx[panel.number()], "log2fc"], col="lightgray", lwd=2);
         panel.xyplot(...)
       } 
)

```

```{r,fig.height=10, fig.width=10}
resLys8Arg10None <- resLys8Arg10None %>% mutate(foldChangeExp = log2(IntensityN.y / IntensityN.x ))
resLys8Arg10None$Peptide <- as.character(resLys8Arg10None$Peptide)
join <- inner_join(resLys8Arg10None ,theoryRatios , by=c("Peptide" = "Pepsequence"))

xyplot(log2fc ~ foldChangeExp | Experiment, data= join,type = c("p", "r"), col.line = "darkorange", lwd = 1)

```


```{r, fig.height=10}
join$foldChangeExp[join$foldChangeExp == -Inf] <- NA
corExp <- join %>% group_by(Experiment, week) %>% summarise(cor=cor(foldChangeExp ,log2fc, method="spearman",use= "pairwise.complete.obs" ))
par(mar=c(22,4,2,2))
plot(corExp$week, corExp$cor^2, las=2, ylim=c(0,1), ylab = "R^2 (spearman)", type="b", xlab="week", axes=F)
axis(2,at=seq(0,1,by=0.1))
axis(1,at=min(corExp$week):max(corExp$week),las=2)

```




























